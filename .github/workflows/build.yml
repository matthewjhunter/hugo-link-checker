name: Build Binaries

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_call:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: [ '1.21' ]
        os-arch:
          - os: linux
            arch: amd64
          - os: darwin
            arch: amd64
          - os: darwin
            arch: arm64
          - os: windows
            arch: amd64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ matrix.go-version }}

      - name: Build
        shell: bash
        run: |
          set -euo pipefail
          os="${{ matrix.os-arch.os }}"
          arch="${{ matrix.os-arch.arch }}"
          ext=""
          if [ "${os}" = "windows" ]; then ext=".exe"; fi
          mkdir -p dist
          echo "Building for ${os}/${arch}"
          CGO_ENABLED=0 GOOS=${os} GOARCH=${arch} go build -ldflags "-s -w" -o dist/hugo-link-checker-${os}-${arch}${ext} ./cmd/hugo-link-checker
          
          # Compress binaries for Linux and macOS
          if [ "${os}" != "windows" ]; then
            echo "Compressing binary for ${os}/${arch}"
            gzip dist/hugo-link-checker-${os}-${arch}${ext}
          fi

      - name: Debug artifact info
        shell: bash
        run: |
          artifact_name="hugo-link-checker-${{ matrix.os-arch.os }}-${{ matrix.os-arch.arch }}"
          echo "Uploading artifact with name: ${artifact_name}"
          echo "Files to upload:"
          ls -la dist/hugo-link-checker-${{ matrix.os-arch.os }}-${{ matrix.os-arch.arch }}*

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: hugo-link-checker-${{ matrix.os-arch.os }}-${{ matrix.os-arch.arch }}
          path: dist/hugo-link-checker-${{ matrix.os-arch.os }}-${{ matrix.os-arch.arch }}*

  build-deb:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        go-version: [ '1.21' ]
        arch: [ 'amd64', 'arm64' ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ matrix.go-version }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential debhelper dh-golang

      - name: Build binary for packaging
        run: |
          mkdir -p dist
          CGO_ENABLED=0 GOOS=linux GOARCH=${{ matrix.arch }} go build -ldflags "-s -w" -o dist/hugo-link-checker ./cmd/hugo-link-checker

      - name: Create Debian package
        run: |
          # Extract version from source code
          VERSION=$(grep 'var Version = ' internal/version/version.go | sed 's/.*"\(.*\)".*/\1/')
          if [ -z "$VERSION" ]; then
            echo "Error: Could not extract version from source code"
            exit 1
          fi
          echo "Using version from source: $VERSION"
          
          # Create package directory structure
          PKG_DIR="hugo-link-checker_${VERSION}_${{ matrix.arch }}"
          mkdir -p "${PKG_DIR}/DEBIAN"
          mkdir -p "${PKG_DIR}/usr/bin"
          mkdir -p "${PKG_DIR}/usr/share/doc/hugo-link-checker"
          
          # Copy binary
          cp dist/hugo-link-checker "${PKG_DIR}/usr/bin/"
          chmod 755 "${PKG_DIR}/usr/bin/hugo-link-checker"
          
          # Copy documentation
          cp README.md "${PKG_DIR}/usr/share/doc/hugo-link-checker/"
          
          # Create control file
          cat > "${PKG_DIR}/DEBIAN/control" << EOF
          Package: hugo-link-checker
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: ${{ matrix.arch }}
          Maintainer: Hugo Link Checker Team <matthew@infodancer.org>
          Description: Link checker for Hugo static sites
           A command-line tool to check for broken links in Hugo static sites.
           Supports checking both internal and external links, with various
           output formats including text, JSON, and HTML reports.
          Homepage: https://github.com/your-org/hugo-link-checker
          EOF
          
          # Build the package
          dpkg-deb --build "${PKG_DIR}"
          
          # Move to dist directory
          mv "${PKG_DIR}.deb" dist/

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: hugo-link-checker-deb-${{ matrix.arch }}
          path: dist/*.deb
