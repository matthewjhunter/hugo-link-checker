name: Build Binaries

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: [ '1.21' ]
        os-arch:
          - os: linux
            arch: amd64
          - os: darwin
            arch: amd64
          - os: darwin
            arch: arm64
          - os: windows
            arch: amd64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ matrix.go-version }}

      - name: Build
        shell: bash
        run: |
          set -euo pipefail
          os="${{ matrix.os-arch.os }}"
          arch="${{ matrix.os-arch.arch }}"
          ext=""
          if [ "${os}" = "windows" ]; then ext=".exe"; fi
          mkdir -p dist
          echo "Building for ${os}/${arch}"
          CGO_ENABLED=0 GOOS=${os} GOARCH=${arch} go build -ldflags "-s -w" -o dist/hugo-link-checker-${os}-${arch}${ext} ./cmd/hugo-link-checker
          
          # Compress binaries for Linux and macOS
          if [ "${os}" != "windows" ]; then
            echo "Compressing binary for ${os}/${arch}"
            gzip dist/hugo-link-checker-${os}-${arch}${ext}
          fi

      - name: Debug artifact info
        shell: bash
        run: |
          artifact_name="hugo-link-checker-${{ matrix.os-arch.os }}-${{ matrix.os-arch.arch }}"
          echo "Uploading artifact with name: ${artifact_name}"
          echo "Files to upload:"
          ls -la dist/hugo-link-checker-${{ matrix.os-arch.os }}-${{ matrix.os-arch.arch }}*

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: hugo-link-checker-${{ matrix.os-arch.os }}-${{ matrix.os-arch.arch }}
          path: dist/hugo-link-checker-${{ matrix.os-arch.os }}-${{ matrix.os-arch.arch }}*
